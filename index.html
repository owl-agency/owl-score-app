<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owl Score - Diagnostic Marketing Digital</title>
    
    <!-- Ajout des polices depuis Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
	    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Colors */
            --color-background: rgba(252, 252, 249, 1);
            --color-surface: rgba(255, 255, 253, 1);
            --color-text: rgba(19, 52, 59, 1);
            --color-text-secondary: rgba(98, 108, 113, 1);
            --color-primary: rgba(33, 128, 141, 1);
            --color-primary-hover: rgba(29, 116, 128, 1);
            --color-primary-active: rgba(26, 104, 115, 1);
            --color-secondary: rgba(241, 245, 249, 1);
            --color-secondary-hover: rgba(226, 232, 240, 1);
            --color-border: rgba(224, 224, 224, 1);
            --color-btn-primary-text: rgba(252, 252, 249, 1);
            --color-card-border: rgba(230, 230, 230, 1);
            --color-focus-ring: rgba(33, 128, 141, 0.4);

            /* Typography - Mise √† jour pour utiliser la police import√©e en priorit√© */
            --font-family-base: "Poppins", sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 700;

            /* Spacing & Radius */
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.02);
        }

        /* Correction pour le d√©bordement des champs de formulaire */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: var(--space-16);
            -webkit-font-smoothing: antialiased;
            font-weight: var(--font-weight-normal);
        }
        
        * {
            font-weight: var(--font-weight-normal);
        }

        h1, h2, h3, h4, strong, .option-label, .maturity-level span, .score-circle span, .modal-header h3 {
            font-weight: var(--font-weight-bold);
        }
        .btn, .axis-item, .form-label, .progress-text, .question-category-display {
             font-weight: var(--font-weight-medium);
        }

        .container { max-width: 768px; margin: 0 auto; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background-color: var(--color-surface); border-radius: var(--radius-xl); padding: var(--space-32); border: 1px solid var(--color-card-border); box-shadow: var(--shadow-lg); margin-top: var(--space-24); }
        .card__body { padding: 0; }
        .card__body h2 { font-size: 1.5rem; margin-bottom: var(--space-8); }
        .header { text-align: center; margin-bottom: var(--space-24); }
        .header h1 { font-size: 2.2rem; color: #1F2937; margin:0; }
        .header .subtitle { font-size: 1.1rem; color: var(--color-text-secondary); }
        
        .owl-logo { margin-bottom: 1rem; }
        .owl { display: inline-block; width: 60px; height: 60px; }
        .owl-body { width: 100%; height: 100%; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-active)); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: relative; animation: owlFloat 3s ease-in-out infinite; }
        .owl-eyes { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .eye { width: 12px; height: 12px; background: white; border-radius: 50%; position: relative; animation: blink 4s infinite; }
        .pupil { width: 6px; height: 6px; background: var(--color-text); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.1s ease-out; }
        .owl-beak { position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 7px solid #f59e0b; }
        @keyframes owlFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-12) var(--space-24); border-radius: var(--radius-base); font-size: 1rem; cursor: pointer; transition: all 0.2s ease; border: none; text-decoration: none; }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--secondary { background: var(--color-secondary); color: var(--color-text); }
        .btn--secondary:hover { background-color: var(--color-secondary-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .cta-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
        
        .axes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-12); margin: var(--space-24) 0; }
        .axis-item { background: var(--color-secondary); padding: var(--space-12); border-radius: var(--radius-base); text-align: center; transition: all 0.2s ease; }
        .axis-item:hover { background: var(--color-secondary-hover); }

        .progress-bar { width: 100%; height: 8px; background: var(--color-secondary); border-radius: var(--radius-full); overflow: hidden; margin-bottom: var(--space-8); }
        .progress-fill { height: 100%; background: var(--color-primary); border-radius: var(--radius-full); transition: width 0.4s ease; width: 0%; }
        
        .question-category-display { text-align: center; margin-bottom: var(--space-16); padding: var(--space-8) var(--space-16); background-color: var(--color-secondary); border-radius: var(--radius-full); display: inline-block; left: 50%; position: relative; transform: translateX(-50%); }

        .question-card h3 { margin-bottom: var(--space-24); font-size: 1.4rem; }
        .options { display: flex; flex-direction: column; gap: var(--space-12); }
        .option { padding: var(--space-16); border: 2px solid var(--color-border); border-radius: var(--radius-lg); background: var(--color-surface); cursor: pointer; transition: all 0.2s ease; }
        .option:hover { border-color: var(--color-primary); background: rgba(33, 128, 141, 0.05); }
        .option.selected { border-color: var(--color-primary); background: rgba(33, 128, 141, 0.1); box-shadow: 0 0 0 2px var(--color-primary); }
        .option-description { font-size: 0.9rem; color: var(--color-text-secondary); }
        .quiz-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-24); }

        .results-header { text-align: center; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-active)); display: flex; align-items: center; justify-content: center; margin: var(--space-16) auto; }
        
        .chart-container { height: 350px; margin: var(--space-32) auto; }
        .recommendations { margin-top: 2rem; }
        .recommendations h3 { color: var(--color-primary); border-bottom: 2px solid var(--color-primary); padding-bottom: var(--space-8); margin-bottom: var(--space-16); }
        .recommendations h4 { font-size: 1.1rem; margin-top: 1.5rem; }
        
        .loader { text-align: center; padding: 40px; }
        .loader-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .disclaimer { font-size: 0.8rem; color: var(--color-text-secondary); text-align: center; margin-top: var(--space-32); border-top: 1px solid var(--color-border); padding-top: var(--space-16); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--color-surface); border-radius: var(--radius-lg); max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-16); border-bottom: 1px solid var(--color-border); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal form { padding: var(--space-24); }
        .form-group { margin-bottom: var(--space-16); }
        .form-label { display: block; margin-bottom: var(--space-8); }
        .form-control { display: block; width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); }
        .form-control:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-focus-ring); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
             <div class="header">
	                        <!-- Ajout des pupilles du hibou -->

                <div class="owl-logo"><div class="owl"><div class="owl-body"><div class="owl-eyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div><div class="owl-beak"></div></div></div></div>

                <h1>Owl Score</h1>
                <p class="subtitle">Diagnostic de Maturit√© Marketing Digital</p>
            </div>
            <div class="card">
                 <div class="card__body">
                    <h2>√âvaluez votre maturit√© marketing digital</h2>
                    <p>D√©couvrez le niveau de maturit√© de votre strat√©gie marketing digital √† travers 12 axes essentiels :</p>
                    <div id="axes-grid" class="axes-grid"></div>
                    <div class="cta-buttons">
                        <button class="btn btn--primary" onclick="startQuiz()">Commencer le diagnostic</button>
                        <button class="btn btn--secondary" onclick="showDemo()">Voir un exemple</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen">
            <div class="card">
                <div class="quiz-header">
                    <div id="question-category-display"></div>
                    <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                    <p id="progress-text" class="progress-text"></p>
                </div>
                <div class="question-card">
                    <h3 id="question-text"></h3>
                    <div id="question-options" class="options"></div>
                </div>
                <div class="quiz-navigation">
                    <div>
                        <button class="btn btn--secondary" id="home-btn" onclick="goHome()">Accueil</button>
                        <button class="btn btn--secondary" id="prev-btn" onclick="previousQuestion()">Pr√©c√©dent</button>
                    </div>
                    <button class="btn btn--secondary" id="skip-btn" onclick="skipTheme()">Ne s'applique pas</button>
                </div>
            </div>
        </div>

        <!-- Light Results Screen -->
        <div id="light-results-screen" class="screen">
             <div class="card">
                <div class="results-header">
                    <h2>Votre Diagnostic Rapide</h2>
                    <div class="overall-score">
                        <div class="score-circle"><span id="light-overall-score">0%</span></div>
                        <div class="maturity-level"><span id="light-maturity-level"></span></div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="light-radar-chart"></canvas>
                </div>
                <div id="light-recommendations" class="recommendations"></div>
                <div class="cta-buttons">
                    <button class="btn btn--primary" onclick="showLeadForm()">Obtenir le diagnostic complet et d√©taill√©</button>
                    <button class="btn btn--secondary" onclick="restartQuiz()">Refaire le diagnostic</button>
                </div>
                <div class="disclaimer">
                    Ce diagnostic est g√©n√©r√© par une IA dompt√©e par Owl Agency et constitue une premi√®re √©valuation. Pour des recommandations enti√®rement personnalis√©es, patientez un tout petit peu et on vous recontactera.
                </div>
            </div>
        </div>

        <!-- Full Report Screen -->
        <div id="full-report-screen" class="screen">
            <div class="card" id="full-report-content">
                 <div class="results-header">
                    <h2>Votre Diagnostic Complet</h2>
                 </div>
                 <div id="full-recommendations" class="recommendations"></div>
                 <div class="cta-buttons">
                    <button class="btn btn--primary" onclick="downloadPDF()">T√©l√©charger le rapport PDF</button>
                    <button class="btn btn--secondary" onclick="restartQuiz()">Refaire le diagnostic</button>
                 </div>
                 <div class="disclaimer">
                    Ce diagnostic est g√©n√©r√© par une IA et constitue une premi√®re √©valuation. Pour des recommandations enti√®rement personnalis√©es, consultez un expert.
                </div>
            </div>
        </div>
        
        <!-- Lead Form Modal -->
        <div id="lead-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Recevez votre rapport d√©taill√©</h3>
                    <button class="modal-close" onclick="closeLeadForm()">&times;</button>
                </div>
                <form id="lead-form" onsubmit="submitLeadForm(event)">
                    <div class="form-group"><label class="form-label" for="firstname">Pr√©nom *</label><input type="text" id="firstname" class="form-control" required></div>
                    <div class="form-group"><label class="form-label" for="email">Email *</label><input type="email" id="email" class="form-control" required></div>
                    <div class="form-group"><label class="form-label" for="company">Entreprise</label><input type="text" id="company" class="form-control"></div>
                    <div class="form-group"><label class="form-label" for="sector">Secteur d'activit√©</label><select id="sector" class="form-control"><option value="">S√©lectionnez votre secteur</option><option value="E-commerce">E-commerce</option><option value="B2B">B2B</option><option value="Retail">Retail</option><option value="Services">Services</option></select></div>
                    <button type="submit" class="btn btn--primary" style="width: 100%;">Voir mon diagnostic complet</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- NOUVEAU CODE POUR LES YEUX DU HIBOU ---
            const pupils = document.querySelectorAll('.pupil');
            window.addEventListener('mousemove', (e) => {
                pupils.forEach(pupil => {
                    // On r√©cup√®re la position du centre de l'oeil
                    const rect = pupil.parentElement.getBoundingClientRect();
                    const eyeX = rect.left + rect.width / 2;
                    const eyeY = rect.top + rect.height / 2;
                    
                    // On calcule l'angle entre le centre de l'oeil et la souris
                    const angle = Math.atan2(e.clientY - eyeY, e.clientX - eyeX);
                    
                    // On limite le mouvement de la pupille √† l'int√©rieur de l'oeil
                    // Le rayon est 1/4 de la largeur de l'oeil pour que la pupille ne touche pas les bords
                    const radius = rect.width / 4; 
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    // On applique la nouvelle position √† la pupille
                    // On utilise translate(-50%, -50%) pour garder la pupille centr√©e quand la souris ne bouge pas
                    pupil.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                });
            });
            // --- FIN DU NOUVEAU CODE ---
            
            
            const APP_CONFIG = {
                axes: [ 
                    { id: 'branding', name: 'Branding', icon: 'üé®' },
                    { id: 'ux', name: 'UX Design', icon: 'üßë‚Äçüíª' },
                    { id: 'analytics', name: 'Analytics', icon: 'üìä' },
                    { id: 'seo', name: 'SEO', icon: 'üîç' },
                    { id: 'social_proof', name: 'Preuve Sociale', icon: '‚≠ê' },
                    { id: 'email', name: 'E-mailing', icon: 'üìß' },
                    { id: 'social', name: 'R√©seaux Sociaux', icon: 'üì±' },
                    { id: 'sea', name: 'Publicit√© Payante', icon: 'üí∞' },
                    { id: 'ecommerce', name: 'E-commerce', icon: 'üõí' },
                    { id: 'automation', name: 'Automation', icon: 'ü§ñ' },
                    { id: 'ai', name: 'IA Marketing', icon: 'üß†' },
                    { id: 'rgpd', name: 'RGPD & Conformit√©', icon: 'üîí' }
                ],
                maturityLevels: { beginner: { min: 0, max: 30, label: 'D√©butant' }, intermediate: { min: 31, max: 60, label: 'Interm√©diaire' }, advanced: { min: 61, max: 80, label: 'Avanc√©' }, expert: { min: 81, max: 100, label: 'Expert' }}
            };

            const QUIZ_QUESTIONS = [
                // 1. Branding
                { id: 1, axis: 'branding', question: "Votre identit√© visuelle (logo, couleurs) est-elle d√©finie et appliqu√©e partout ?", options: [ { value: 0, label: "Non d√©finie", description: "Nous n'avons pas de charte graphique formalis√©e." }, { value: 1, label: "Partiellement", description: "Elle existe mais n'est pas toujours respect√©e." }, { value: 2, label: "Oui, partout", description: "Elle est appliqu√©e sur tous nos supports." }, { value: 3, label: "Oui, et elle √©volue", description: "Nous la mettons √† jour pour rester pertinents." }] },
                { id: 2, axis: 'branding', question: "Avez-vous d√©fini un 'ton de voix' (Tone of Voice) pour votre communication ?", options: [ { value: 0, label: "Non", description: "Nous √©crivons sans ligne directrice pr√©cise." }, { value: 1, label: "Informel", description: "Le ton d√©pend de la personne qui √©crit." }, { value: 2, label: "Oui, d√©fini", description: "Nous avons un guide sur le ton √† employer." }, { value: 3, label: "Oui, et partag√©", description: "Toute l'√©quipe conna√Æt et applique notre ton de voix." }] },
                { id: 3, axis: 'branding', question: "Votre proposition de valeur unique est-elle claire et visible ?", options: [ { value: 0, label: "Non formul√©e", description: "Nous n'avons pas formalis√© ce qui nous rend unique." }, { value: 1, label: "D√©finie en interne", description: "Nous savons ce qui nous diff√©rencie, mais nos clients pas forc√©ment." }, { value: 2, label: "Visible", description: "Elle est clairement indiqu√©e sur notre site et nos documents." }, { value: 3, label: "Int√©gr√©e partout", description: "Toute notre communication renforce notre proposition de valeur." }] },
                // 2. UX Design
                { id: 4, axis: 'ux', question: "Votre site web est-il optimis√© pour les mobiles ?", options: [ { value: 0, label: "Non", description: "Il n'est pas 'responsive'." }, { value: 1, label: "Oui, il est responsive", description: "Mais l'exp√©rience pourrait √™tre meilleure." }, { value: 2, label: "Mobile-first", description: "Nous concevons d'abord pour le mobile." }, { value: 3, label: "Exp√©rience d√©di√©e", description: "Contenu et ergonomie sp√©cifiques au mobile." }] },
                { id: 5, axis: 'ux', question: "La navigation et les appels √† l'action (CTA) de votre site sont-ils clairs ?", options: [ { value: 0, label: "Pas vraiment", description: "Les utilisateurs se perdent souvent." }, { value: 1, label: "Assez clairs", description: "Le menu est simple, les CTA sont visibles." }, { value: 2, label: "Tr√®s clairs", description: "L'architecture est logique et les CTA sont incitatifs." }, { value: 3, label: "Test√©s et optimis√©s", description: "Nous testons l'efficacit√© de nos parcours et CTA." }] },
                { id: 6, axis: 'ux', question: "Comment collectez-vous le feedback de vos utilisateurs ?", options: [ { value: 0, label: "Jamais", description: "" }, { value: 1, label: "Informellement", description: "Via les emails ou les r√©seaux sociaux." }, { value: 2, label: "Par des enqu√™tes", description: "Nous envoyons des sondages de satisfaction." }, { value: 3, label: "En continu", description: "Avec des outils de feedback et des tests utilisateurs." }] },
                // 3. Analytics
                { id: 7, axis: 'analytics', question: "Avez-vous install√© et configur√© un outil d'analyse d'audience (ex: Google Analytics 4) ?", options: [ { value: 0, label: "Non", description: "Aucun suivi de l'audience." }, { value: 1, label: "Oui, mais pas configur√©", description: "Le code est install√©, mais nous n'analysons rien." }, { value: 2, label: "Configuration de base", description: "Nous suivons les pages vues et les sources de trafic." }, { value: 3, label: "Configuration avanc√©e", description: "Nous suivons les √©v√©nements, conversions et cohortes." }] },
                { id: 8, axis: 'analytics', question: "Suivez-vous des objectifs de conversion clairs ?", options: [ { value: 0, label: "Non", description: "Aucun objectif d√©fini." }, { value: 1, label: "Objectifs de trafic", description: "Notre seul but est d'augmenter le nombre de visiteurs." }, { value: 2, label: "Objectifs de macro-conversion", description: "Nous suivons les ventes ou les formulaires de contact." }, { value: 3, label: "Micro et Macro", description: "Nous suivons aussi les √©tapes interm√©diaires (ex: ajout au panier)." }] },
                { id: 9, axis: 'analytics', question: "Comment les donn√©es influencent-elles vos d√©cisions marketing ?", options: [ { value: 0, label: "Pas du tout", description: "Nous nous basons sur l'intuition." }, { value: 1, label: "Rapports mensuels", description: "Nous consultons les rapports de performance de temps en temps." }, { value: 2, label: "Suivi r√©gulier", description: "Nous ajustons nos campagnes en fonction des r√©sultats hebdomadaires." }, { value: 3, label: "Data-driven", description: "Toutes nos d√©cisions strat√©giques sont bas√©es sur les donn√©es." }] },
                // 4. SEO
                { id: 10, axis: 'seo', question: "Quelle est votre approche de la recherche de mots-cl√©s ?", options: [ { value: 0, label: "Aucune", description: "Nous ne faisons pas de recherche de mots-cl√©s." }, { value: 1, label: "Ponctuelle", description: "Une analyse a √©t√© faite il y a longtemps." }, { value: 2, label: "R√©guli√®re", description: "Nous mettons √† jour nos mots-cl√©s pour les nouveaux contenus." }, { value: 3, label: "Strat√©gique", description: "Nous avons une veille concurrentielle et s√©mantique continue." }] },
                { id: 11, axis: 'seo', question: "Comment √©valuez-vous la qualit√© technique de votre site pour le SEO ?", options: [ { value: 0, label: "Jamais", description: "Nous n'avons aucun outil pour cela." }, { value: 1, label: "Manuellement", description: "Nous v√©rifions quelques points de temps en temps." }, { value: 2, label: "Avec des outils", description: "Nous utilisons la Google Search Console ou des outils similaires." }, { value: 3, label: "Audits complets", description: "Nous r√©alisons des audits techniques SEO r√©guliers." }] },
                { id: 12, axis: 'seo', question: "Comment travaillez-vous votre popularit√© (backlinks) ?", options: [ { value: 0, label: "Pas du tout", description: "Nous n'avons aucune action de netlinking." }, { value: 1, label: "Naturellement", description: "Nous esp√©rons obtenir des liens gr√¢ce √† notre contenu." }, { value: 2, label: "Ponctuellement", description: "Nous menons quelques actions (annuaires, articles invit√©s)." }, { value: 3, label: "Strat√©giquement", description: "Nous avons une strat√©gie de netlinking proactive et continue." }] },
                // 5. Preuve Sociale
                { id: 13, axis: 'social_proof', question: "Encouragez-vous et collectez-vous activement les avis de vos clients ?", options: [ { value: 0, label: "Non", description: "Nous ne demandons jamais d'avis." }, { value: 1, label: "Passivement", description: "Les clients peuvent laisser des avis s'ils le souhaitent." }, { value: 2, label: "Activement", description: "Nous envoyons un email pour demander un avis apr√®s un achat." }, { value: 3, label: "Syst√©matiquement", description: "La collecte est automatis√©e et nous r√©pondons √† tous les avis." }] },
                { id: 14, axis: 'social_proof', question: "Utilisez-vous les avis et t√©moignages clients dans votre marketing ?", options: [ { value: 0, label: "Non", description: "" }, { value: 1, label: "Rarement", description: "Nous avons une page 'T√©moignages' peu visible." }, { value: 2, label: "R√©guli√®rement", description: "Nous int√©grons les meilleurs avis sur nos pages de vente." }, { value: 3, label: "Partout", description: "Les avis sont un √©l√©ment cl√© de notre site, nos emails et nos publicit√©s." }] },
                { id: 15, axis: 'social_proof', question: "Avez-vous un programme pour transformer vos clients en ambassadeurs ?", options: [ { value: 0, label: "Non", description: "Aucun programme de ce type." }, { value: 1, label: "Informel", description: "Nous comptons sur le bouche-√†-oreille naturel." }, { value: 2, label: "Programme de parrainage", description: "Nous offrons une r√©compense pour les recommandations." }, { value: 3, label: "Programme d'affiliation", description: "Nous avons un syst√®me structur√© pour nos partenaires." }] },
                // 6. E-mailing
                { id: 16, axis: 'email', question: "Comment collectez-vous de nouveaux contacts emails ?", options: [ { value: 0, label: "Pas de collecte", description: "" }, { value: 1, label: "Formulaire simple", description: "Un formulaire de contact ou d'inscription newsletter." }, { value: 2, label: "Ressources √† t√©l√©charger", description: "Nous offrons un e-book, un webinaire, etc." }, { value: 3, label: "Multiple et optimis√©", description: "Pop-ups, formulaires embarqu√©s, jeux-concours, etc." }] },
                { id: 17, axis: 'email', question: "Comment segmentez-vous vos listes d'emails ?", options: [ { value: 0, label: "Pas de segmentation", description: "Nous envoyons le m√™me email √† tout le monde." }, { value: 1, label: "Basique", description: "Par type de client (prospect vs client)." }, { value: 2, label: "Comportementale", description: "Bas√©e sur les achats ou les visites du site." }, { value: 3, label: "Avanc√©e", description: "Segmentation dynamique bas√©e sur de multiples crit√®res." }] },
                { id: 18, axis: 'email', question: "Utilisez-vous l'A/B testing pour vos campagnes email ?", options: [ { value: 0, label: "Jamais", description: "" }, { value: 1, label: "Sur les objets", description: "Pour am√©liorer le taux d'ouverture." }, { value: 2, label: "Sur le contenu", description: "Pour am√©liorer le taux de clic." }, { value: 3, label: "De mani√®re syst√©matique", description: "Nous testons objets, contenus et CTA en continu." }] },
                // 7. Social Media
                { id: 19, axis: 'social', question: "Votre strat√©gie sur les r√©seaux sociaux est-elle planifi√©e ?", options: [ { value: 0, label: "Pas de strat√©gie", description: "Nous publions au jour le jour." }, { value: 1, label: "Planification simple", description: "Nous avons une id√©e des th√®mes √† aborder." }, { value: 2, label: "Calendrier √©ditorial", description: "Nous planifions nos publications sur plusieurs semaines." }, { value: 3, label: "Strat√©gie int√©gr√©e", description: "Le calendrier est li√© √† nos objectifs marketing globaux." }] },
                { id: 20, axis: 'social', question: "Comment interagissez-vous avec votre communaut√© ?", options: [ { value: 0, label: "Tr√®s peu", description: "Nous ne r√©pondons pas ou rarement." }, { value: 1, label: "R√©activement", description: "Nous r√©pondons aux questions et commentaires." }, { value: 2, label: "Proactivement", description: "Nous lan√ßons des conversations et des sondages." }, { value: 3, label: "Community Management", description: "Nous animons et mod√©rons activement notre communaut√©." }] },
                { id: 21, axis: 'social', question: "Utilisez-vous la publicit√© sur les r√©seaux sociaux (Social Ads) ?", options: [ { value: 0, label: "Non", description: "Nous comptons uniquement sur le bio." }, { value: 1, label: "Boost de posts", description: "Nous sponsorisons nos meilleures publications." }, { value: 2, label: "Campagnes cibl√©es", description: "Nous cr√©ons des campagnes avec des audiences pr√©cises." }, { value: 3, label: "Retargeting et Lookalike", description: "Nous utilisons des strat√©gies publicitaires avanc√©es." }] },
                // 8. SEA
                { id: 22, axis: 'sea', question: "G√©rez-vous des campagnes de publicit√© payante (Google Ads, Social Ads) ?", options: [ { value: 0, label: "Non, aucune", description: "Nous n'utilisons pas la publicit√© payante." }, { value: 1, label: "Occasionnellement", description: "Nous sponsorisons quelques posts ou campagnes ponctuelles." }, { value: 2, label: "R√©guli√®rement", description: "Nous avons des campagnes actives en continu." }, { value: 3, label: "De mani√®re optimis√©e", description: "Nos campagnes sont pilot√©es par le ROI et l'A/B testing." }] },
                { id: 23, axis: 'sea', question: "Comment mesurez-vous le retour sur investissement (ROI) de vos publicit√©s ?", options: [ { value: 0, label: "Pas de mesure", description: "Nous ne suivons pas les conversions." }, { value: 1, label: "Partiellement", description: "Nous suivons les clics et le co√ªt, mais pas les ventes." }, { value: 2, label: "Suivi des conversions", description: "Nous suivons les conversions (ventes, leads) par campagne." }, { value: 3, label: "Attribution avanc√©e", description: "Nous utilisons un mod√®le d'attribution pour √©valuer chaque canal." }] },
                { id: 24, axis: 'sea', question: "Vos pages de destination (landing pages) sont-elles optimis√©es pour la conversion ?", options: [ { value: 0, label: "Non d√©di√©es", description: "Nous renvoyons vers la page d'accueil." }, { value: 1, label: "Pages de base", description: "Nous avons des pages de destination, mais non optimis√©es." }, { value: 2, label: "Optimis√©es", description: "Les pages sont claires, avec un appel √† l'action unique." }, { value: 3, label: "Test√©es et optimis√©es", description: "Nous A/B testons r√©guli√®rement nos landing pages." }] },
                // 9. E-commerce
                { id: 25, axis: 'ecommerce', question: "Vos fiches produits sont-elles optimis√©es pour la vente ?", options: [ { value: 0, label: "Pas d'e-commerce", description: "" }, { value: 1, label: "Basiques", description: "Titre, prix et une photo." }, { value: 2, label: "D√©taill√©es", description: "Multiples photos, descriptions compl√®tes, caract√©ristiques." }, { value: 3, label: "Enrichies", description: "Avec des avis clients, des vid√©os, des FAQs." }] },
                { id: 26, axis: 'ecommerce', question: "Le processus de paiement est-il simple et rapide ?", options: [ { value: 0, label: "Pas d'e-commerce", description: "" }, { value: 1, label: "Complexe", description: "Plusieurs pages, beaucoup de champs √† remplir." }, { value: 2, label: "Standard", description: "Un processus de paiement classique en plusieurs √©tapes." }, { value: 3, label: "Optimis√©", description: "Paiement en une page, options de paiement rapide (Paypal, etc.)." }] },
                { id: 27, axis: 'ecommerce', question: "Quelle est votre strat√©gie pour les paniers abandonn√©s ?", options: [ { value: 0, label: "Pas d'e-commerce", description: "" }, { value: 1, label: "Aucune", description: "Nous ne faisons rien de sp√©cifique." }, { value: 2, label: "Relance simple", description: "Nous envoyons un email de relance unique." }, { value: 3, label: "S√©quence de relance", description: "Nous avons une s√©quence d'emails automatis√©e et personnalis√©e." }] },
                // 10. Automation
                { id: 28, axis: 'automation', question: "Utilisez-vous des sc√©narios de marketing automation ?", options: [ { value: 0, label: "Non", description: "Toutes nos actions sont manuelles." }, { value: 1, label: "Pour les bases", description: "Email de bienvenue, confirmation de commande." }, { value: 2, label: "Pour le nurturing", description: "S√©quences d'emails pour √©duquer les prospects." }, { value: 3, label: "Pour tout le cycle", description: "Du premier contact √† la fid√©lisation post-achat." }] },
                { id: 29, axis: 'automation', question: "Comment qualifiez-vous et assignez-vous les leads entrants ?", options: [ { value: 0, label: "Manuellement", description: "Un commercial traite chaque nouveau contact." }, { value: 1, label: "Tri par formulaire", description: "Les contacts sont tri√©s selon le formulaire rempli." }, { value: 2, label: "Lead Scoring", description: "Nous attribuons des points en fonction des actions." }, { value: 3, label: "Automatis√©", description: "Le scoring et l'assignation aux commerciaux sont automatiques." }] },
                { id: 30, axis: 'automation', question: "Vos outils marketing sont-ils int√©gr√©s entre eux ?", options: [ { value: 0, label: "Pas d'int√©gration", description: "Outils isol√©s." }, { value: 1, label: "Quelques connexions", description: "Int√©grations ponctuelles (ex: Zapier)." }, { value: 2, label: "√âcosyst√®me connect√©", description: "Principaux outils int√©gr√©s nativement." }, { value: 3, label: "Plateforme unifi√©e", description: "Tous les outils sont synchronis√©s dans un CRM/CDP." }] },
                // 11. IA
                { id: 31, axis: 'ai', question: "Utilisez-vous l'IA pour la cr√©ation de contenu ?", options: [ { value: 0, label: "Non", description: "Toute la cr√©ation est manuelle." }, { value: 1, label: "Pour l'inspiration", description: "G√©n√©ration d'id√©es de titres ou de plans." }, { value: 2, label: "Pour la r√©daction", description: "Aide √† la r√©daction de brouillons d'articles ou de posts." }, { value: 3, label: "Pour l'optimisation", description: "L'IA nous aide √† optimiser le SEO de nos contenus." }] },
                { id: 32, axis: 'ai', question: "L'IA est-elle utilis√©e pour personnaliser l'exp√©rience client ?", options: [ { value: 0, label: "Non", description: "" }, { value: 1, label: "De mani√®re simple", description: "Ex: un chatbot qui r√©pond aux questions fr√©quentes." }, { value: 2, label: "De mani√®re cibl√©e", description: "Ex: recommandations de produits personnalis√©es." }, { value: 3, label: "De mani√®re pr√©dictive", description: "L'IA anticipe les besoins des clients pour adapter le site." }] },
                { id: 33, axis: 'ai', question: "Comment l'IA optimise-t-elle vos campagnes publicitaires ?", options: [ { value: 0, label: "Pas du tout", description: "" }, { value: 1, label: "Via les plateformes", description: "Nous utilisons les optimisations natives de Google/Meta." }, { value: 2, label: "Pour les audiences", description: "Cr√©ation d'audiences similaires (lookalike)." }, { value: 3, label: "Pilotage complet", description: "L'IA g√®re l'allocation de budget et les ench√®res en temps r√©el." }] },
                // 12. RGPD
                { id: 34, axis: 'rgpd', question: "Comment g√©rez-vous le consentement des utilisateurs (cookies, etc.) ?", options: [ { value: 0, label: "Pas de gestion", description: "Nous ne demandons pas le consentement." }, { value: 1, label: "Banni√®re simple", description: "Un simple bandeau 'Accepter'." }, { value: 2, label: "Avec choix", description: "Les utilisateurs peuvent accepter ou refuser." }, { value: 3, label: "Gestion granulaire", description: "Choix par finalit√© et preuve de consentement." }] },
                { id: 35, axis: 'rgpd', question: "Vos formulaires et collectes de donn√©es sont-ils conformes au RGPD ?", options: [ { value: 0, label: "Nous ne savons pas", description: "" }, { value: 1, label: "Partiellement", description: "Nous avons ajout√© des cases √† cocher." }, { value: 2, label: "Oui, en surface", description: "Les finalit√©s sont indiqu√©es clairement." }, { value: 3, label: "Totalement", description: "Consentement, dur√©e de conservation et s√©curit√© sont ma√Ætris√©s." }] },
                { id: 36, axis: 'rgpd', question: "Avez-vous un processus clair pour g√©rer les demandes des utilisateurs (acc√®s, suppression) ?", options: [ { value: 0, label: "Non", description: "" }, { value: 1, label: "Au cas par cas", description: "Nous traitons les demandes quand elles arrivent." }, { value: 2, label: "Processus d√©fini", description: "Nous avons une proc√©dure interne document√©e." }, { value: 3, label: "Processus outill√©", description: "Nous avons un portail ou un outil pour g√©rer ces demandes." }] }
            ];
            
            APP_CONFIG.totalQuestions = QUIZ_QUESTIONS.length;
            let currentQuestionIndex = 0;
            let userAnswers = {};
            let quizResults = null;
            let lightRadarChart = null;

            const dom = {
                axesGrid: document.getElementById('axes-grid'),
                quiz: {
                    progressFill: document.getElementById('progress-fill'),
                    progressText: document.getElementById('progress-text'),
                    questionText: document.getElementById('question-text'),
                    optionsContainer: document.getElementById('question-options'),
                    categoryDisplay: document.getElementById('question-category-display'),
                    homeBtn: document.getElementById('home-btn'),
                    prevBtn: document.getElementById('prev-btn'),
                    skipBtn: document.getElementById('skip-btn')
                },
                lightResults: {
                    score: document.getElementById('light-overall-score'),
                    level: document.getElementById('light-maturity-level'),
                    chart: document.getElementById('light-radar-chart'),
                    recommendations: document.getElementById('light-recommendations')
                },
                 fullReport: {
                    content: document.getElementById('full-report-content'),
                    recommendations: document.getElementById('full-recommendations')
                },
                modal: { self: document.getElementById('lead-modal'), form: document.getElementById('lead-form') }
            };
            
            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }
            
            function getMaturityLevel(percentage) {
                for (const level of Object.values(APP_CONFIG.maturityLevels)) {
                    if (percentage >= level.min && percentage <= level.max) return level;
                } return APP_CONFIG.maturityLevels.beginner;
            }
            
            window.startQuiz = () => { currentQuestionIndex = 0; userAnswers = {}; showScreen('quiz-screen'); displayQuestion(); };
            window.goHome = () => showScreen('home-screen');
            window.showDemo = () => { QUIZ_QUESTIONS.forEach(q => { userAnswers[q.id] = Math.floor(Math.random() * q.options.length); }); calculateAndShowLightResults(); };

            function displayQuestion() {
                const question = QUIZ_QUESTIONS[currentQuestionIndex];
                const axisInfo = APP_CONFIG.axes.find(a => a.id === question.axis);

                dom.quiz.progressFill.style.width = `${((currentQuestionIndex + 1) / APP_CONFIG.totalQuestions) * 100}%`;
                dom.quiz.progressText.textContent = `Question ${currentQuestionIndex + 1} / ${APP_CONFIG.totalQuestions}`;
                dom.quiz.categoryDisplay.innerHTML = `${axisInfo.icon} ${axisInfo.name}`;
                dom.quiz.questionText.textContent = question.question;
                
                dom.quiz.optionsContainer.innerHTML = '';
                question.options.forEach((opt, index) => {
                    const optEl = document.createElement('div');
                    optEl.className = 'option';
                    if (userAnswers[question.id] === index) optEl.classList.add('selected');
                    optEl.innerHTML = `<div class="option-label">${opt.label}</div>${opt.description ? `<div class="option-description">${opt.description}</div>` : ''}`;
                    optEl.onclick = () => selectOption(index);
                    dom.quiz.optionsContainer.appendChild(optEl);
                });
                updateNavButtons();
            }
            
            function selectOption(index) {
                userAnswers[QUIZ_QUESTIONS[currentQuestionIndex].id] = index;
                setTimeout(() => {
                    if (currentQuestionIndex < APP_CONFIG.totalQuestions - 1) {
                        currentQuestionIndex++;
                        displayQuestion();
                    } else {
                        calculateAndShowLightResults();
                    }
                }, 200);
                displayQuestion();
            }
            
            window.previousQuestion = () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(); } };
            
            window.skipTheme = () => {
                const currentAxis = QUIZ_QUESTIONS[currentQuestionIndex].axis;
                let nextIndex = currentQuestionIndex;

                while(nextIndex < APP_CONFIG.totalQuestions && QUIZ_QUESTIONS[nextIndex].axis === currentAxis) {
                    userAnswers[QUIZ_QUESTIONS[nextIndex].id] = 'skipped';
                    nextIndex++;
                }

                if (nextIndex < APP_CONFIG.totalQuestions) {
                    currentQuestionIndex = nextIndex;
                    displayQuestion();
                } else {
                    calculateAndShowLightResults();
                }
            };
            
            function updateNavButtons() {
                dom.quiz.prevBtn.style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
                dom.quiz.homeBtn.style.display = currentQuestionIndex === 0 ? 'inline-flex' : 'none';
            }
            
            function calculateScores() {
                const axesScores = {}, axesQuestions = {};
                APP_CONFIG.axes.forEach(a => { axesScores[a.id] = 0; axesQuestions[a.id] = 0; });

                QUIZ_QUESTIONS.forEach(q => {
                    const answerIndex = userAnswers[q.id];
                    if (answerIndex !== undefined && answerIndex !== 'skipped') {
                        axesScores[q.axis] += q.options[answerIndex].value;
                        axesQuestions[q.axis]++;
                    }
                });

                const axesPercentages = {};
                APP_CONFIG.axes.forEach(a => {
                    const maxScore = axesQuestions[a.id] * 3;
                    axesPercentages[a.id] = maxScore > 0 ? Math.round((axesScores[a.id] / maxScore) * 100) : 0;
                });

                const totalScore = Object.values(axesScores).reduce((s, c) => s + c, 0);
                const totalAnsweredQuestions = Object.values(axesQuestions).reduce((s, c) => s + c, 0);
                const maxTotalScore = totalAnsweredQuestions * 3;

                const globalPercentage = maxTotalScore > 0 ? Math.round((totalScore / maxTotalScore) * 100) : 0;

                quizResults = { globalPercentage, axesPercentages, maturityLevel: getMaturityLevel(globalPercentage) };
            }

            async function calculateAndShowLightResults() {
                showScreen('light-results-screen');
                dom.lightResults.recommendations.innerHTML = `<div class="loader"><div class="loader-spinner"></div><p>Analyse IA en cours...</p></div>`;
                
                calculateScores();
                
                dom.lightResults.score.textContent = `${quizResults.globalPercentage}%`;
                dom.lightResults.level.textContent = quizResults.maturityLevel.label;
                createLightRadarChart();

                const prompt = `En tant que consultant senior pour Owl Agency, une agence sp√©cialis√©e dans la strat√©gie marketing digitale, analyse le score suivant.
Notre ton est sage, p√©dagogue et encourageant.

Le score global de maturit√© marketing d'un prospect est de ${quizResults.globalPercentage}%.

R√©dige un court paragraphe (2-3 phrases maximum) qui interpr√®te ce score. Commence par une phrase positive, explique bri√®vement ce que ce niveau de maturit√© implique, et termine par une note encourageante sur le potentiel de croissance.`;
                const summary = await generateAIResponse(prompt);
                dom.lightResults.recommendations.innerHTML = `<p>${summary}</p>`;
            }
            
            function createLightRadarChart() {
                if (lightRadarChart) lightRadarChart.destroy();
                const ctx = dom.lightResults.chart.getContext('2d');
                lightRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: APP_CONFIG.axes.map(a => a.name),
                        datasets: [{
                            label: 'Votre score',
                            data: APP_CONFIG.axes.map(a => quizResults.axesPercentages[a.id]),
                            backgroundColor: 'rgba(33, 128, 141, 0.2)',
                            borderColor: 'rgba(33, 128, 141, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 100, pointLabels: { font: { size: 12 } } } }, plugins: { legend: { display: false } } }
                });
            }

            async function generateAndShowFullReport(sector) {
     showScreen('full-report-screen');
     dom.fullReport.recommendations.innerHTML = `<div class="loader"><div class="loader-spinner"></div><p>G√©n√©ration de votre rapport complet...</p></div>`;

    const answeredQuestions = QUIZ_QUESTIONS.filter(q => userAnswers[q.id] !== 'skipped');
    const userSummary = answeredQuestions.map(q => `- ${q.question}: ${q.options[userAnswers[q.id]]?.label || "Non r√©pondu"}`).join('\n');
    const skippedAxes = APP_CONFIG.axes.filter(axis => answeredQuestions.every(q => q.axis !== axis.id)).map(a => a.name);

    let sectorInfo = sector ? `L'utilisateur a indiqu√© que son secteur d'activit√© est : ${sector}. Adapte tes recommandations √† ce secteur.` : "Le secteur n'a pas √©t√© sp√©cifi√©.";
    if(skippedAxes.length > 0) {
        sectorInfo += ` Ne fais aucune analyse ni recommandation sur les th√©matiques suivantes car elles ont √©t√© saut√©es: ${skippedAxes.join(', ')}.`;
    }

    const prompt = `
**Persona & Ton:**
Tu es un consultant strat√©gique senior pour Owl Agency. Ton ton est celui d'un expert sage, p√©dagogue et visionnaire. Tu ne te contentes pas de lister des faits, tu offres des perspectives et des conseils strat√©giques clairs. Tu es rassurant et tu donnes au prospect une vision claire des prochaines √©tapes. Utilise quelques emojis pour rendre le contenu plus visuel et engageant.

**Contexte du Diagnostic:**
Voici les r√©sultats du diagnostic de maturit√© digitale d'un prospect :
- Secteur d'activit√© : ${sectorInfo}
- Score Global : ${quizResults.globalPercentage}% (${quizResults.maturityLevel.label})
- Scores par Axe : ${JSON.stringify(quizResults.axesPercentages)}
- R√©ponses d√©taill√©es aux questions :
${userSummary}

**T√¢che & Format:**
R√©dige une analyse compl√®te et d√©taill√©e en HTML. Respecte scrupuleusement la structure suivante :

<h3>Analyse Globale : Votre Vision √† 360¬∞ ü¶â</h3>
<p>R√©dige un paragraphe d'introduction (3-4 phrases). Commence par f√©liciter le prospect pour sa d√©marche. Interpr√®te son score global et son niveau de maturit√© en termes d'opportunit√©s. Explique que ce diagnostic est le point de d√©part d'une strat√©gie de croissance r√©fl√©chie.</p>

<h3>‚úÖ Vos Fondations Solides : Ce qui fonctionne d√©j√† tr√®s bien</h3>
<p>Identifie les 2 axes avec les scores les plus √©lev√©s. Pour chaque axe, cr√©e un sous-titre <h4>. Explique en 2 phrases pourquoi c'est une force strat√©gique et comment capitaliser dessus. Sois sp√©cifique en te basant sur les r√©ponses du quiz si possible.</p>

<h3>üéØ Vos Chantiers Prioritaires : L√† o√π se trouve le plus grand potentiel</h3>
<p>Identifie les 2 ou 3 axes avec les scores les plus faibles (parmi les axes non saut√©s). Pour chaque axe, cr√©e un sous-titre <h4>. Explique en 2 phrases pourquoi l'am√©lioration de cet axe est cruciale pour sa croissance future, surtout en lien avec son secteur d'activit√©.</p>

<h3>üöÄ Votre Plan d'Action "Premiers Pas"</h3>
<p>Propose une liste ordonn√©e (<ol>) de 3 actions concr√®tes, simples et √† fort impact que le prospect peut mettre en place d√®s demain. Pour chaque point (<li>), mets le titre de l'action en <strong>, puis explique en 2-3 phrases la m√©thode, en sugg√©rant un outil simple (si pertinent) et le b√©n√©fice attendu. Ces actions doivent √™tre directement li√©es aux axes d'am√©lioration identifi√©s.</p>

<h3>Conclusion : Et maintenant ?</h3>
<p>Termine par un court paragraphe encourageant qui invite le prospect √† voir ce rapport comme une feuille de route. Fais une transition subtile vers une prise de contact avec Owl Agency pour discuter d'une strat√©gie personnalis√©e.</p>
    `;
    const fullReportHtml = await generateAIResponse(prompt);
    dom.fullReport.recommendations.innerHTML = fullReportHtml;

    // On retourne le rapport pour pouvoir l'envoyer au Google Sheet
    return fullReportHtml; 
}

            async function generateAIResponse(prompt) {
    try {
        // L'URL relative vers votre fonction Netlify s√©curis√©e
        const functionUrl = '/.netlify/functions/generate-analysis';

        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompt })
        });

        if (!response.ok) {
            // Si la fonction Netlify elle-m√™me renvoie une erreur (ex: 500)
            throw new Error(`Erreur de la fonction Netlify: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0) {
            let text = result.candidates[0].content.parts[0].text;
            text = text.replace(/^```html\s*/, '').replace(/```\s*$/, '');
            return text;
        }
        // Si la fonction Netlify renvoie une r√©ponse mais sans le contenu attendu
        throw new Error("R√©ponse IA invalide depuis la fonction Netlify");

    } catch (error) {
        console.error("Erreur lors de l'appel √† la fonction Netlify:", error);
        return "<p>D√©sol√©, une erreur est survenue lors de la g√©n√©ration de l'analyse IA. Veuillez r√©essayer.</p>";
    }
}

            window.showLeadForm = () => dom.modal.self.classList.add('active');
            window.closeLeadForm = () => dom.modal.self.classList.remove('active');



window.submitLeadForm = async (event) => {
    event.preventDefault();
    closeLeadForm(); // On ferme le formulaire imm√©diatement

    // 1. On g√©n√®re le rapport complet et on r√©cup√®re le HTML
    const sector = document.getElementById('sector').value;
    const aiAnalysisHtml = await generateAndShowFullReport(sector);

    // 2. On pr√©pare toutes les donn√©es √† envoyer
    const firstname = document.getElementById('firstname').value;
    const email = document.getElementById('email').value;
    const company = document.getElementById('company').value;

    const leadData = { 
        firstname, email, company, sector, 
        score: quizResults.globalPercentage,
        userAnswers: JSON.stringify(userAnswers), // On convertit les r√©ponses en texte JSON
        aiAnalysis: aiAnalysisHtml // On ajoute l'analyse IA
    };

    // On appelle notre nouvelle fonction Netlify s√©curis√©e
    const functionUrl = '/.netlify/functions/submit-form';
    try {
        await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(leadData)
        });
    } catch (e) { 
        console.error("Erreur lors de l'appel √† la fonction submit-form:", e); 
    }
};


             window.downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const reportElement = dom.fullReport.content;
                const pdf = new jsPDF('p', 'pt', 'a4');
                
                html2canvas(reportElement, { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff' // Set a white background to avoid transparent issues
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    let position = 0;
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    let heightLeft = pdfHeight - pageHeight;
                    
                    while (heightLeft >= 0) {
                      position = heightLeft - pdfHeight;
                      pdf.addPage();
                      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                      heightLeft -= pageHeight;
                    }
                    pdf.save('diagnostic-owl-score.pdf');
                });
            };
            
            window.restartQuiz = () => { if (lightRadarChart) lightRadarChart.destroy(); showScreen('home-screen'); };

            function initHomeScreen() {
                const grid = dom.axesGrid;
                grid.innerHTML = '';
                APP_CONFIG.axes.forEach(axis => {
                    const item = document.createElement('div');
                    item.className = 'axis-item';
                    item.textContent = `${axis.icon} ${axis.name}`;
                    grid.appendChild(item);
                });
                showScreen('home-screen');
            }

            initHomeScreen();
        });
    </script>
</body>
</html>